name: XRDP with XFCE and bore.pub (6h max)

on:
  workflow_dispatch:

jobs:
  run-xrdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Maximum allowed duration for GitHub-hosted runners (6 hours)
    
    steps:
      - name: Add fast mirror
        uses: vegardit/fast-apt-mirror.sh@v1
      - name: Update & Install XRDP + XFCE (minimal)
        run: |
          sudo apt-get update
          sudo apt-get install -y xrdp xfce4 dbus-x11
          echo "xfce4-session" > ~/.xsession
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Create admin user 'topuser' with password
        run: |
          sudo adduser --disabled-password --gecos "" topuser
          echo 'topuser:A@12345' | sudo chpasswd
          sudo usermod -aG sudo topuser
          sudo mkdir -p /home/topuser
          sudo cp /home/runner/.xsession /home/topuser/
          sudo chown -R topuser:topuser /home/topuser

      - name: Download and run bore.pub (Expose port 3389)
        run: |
          wget https://github.com/ekzhang/bore/releases/download/v0.4.1/bore-x86_64-unknown-linux-gnu.tar.gz -O bore.tar.gz
          tar -xzf bore.tar.gz
          chmod +x bore
          ./bore local 3389 --to bore.pub > bore-url.txt 2>&1 &
          sleep 5
          cat bore-url.txt

      - name: Show XRDP connection info
        run: |
          echo "==============================================="
          echo "‚úÖ XRDP with XFCE is ready via bore.pub!"
          echo "üîê Login credentials:"
          echo "   Username: topuser"
          echo "   Password: A@12345"
          echo ""
          echo "üåç Public bore.pub tunnel info (check logs above):"
          cat bore-url.txt || echo 'URL not captured.'
          echo "==============================================="
