name: Ubuntu GNOME XRDP via bore

on: [push, workflow_dispatch]

jobs:
  xrdp-via-bore:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Run up to 6 hours

    steps:
    - name: Install XRDP and GNOME Desktop
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xrdp ubuntu-gnome-desktop dbus-x11

    - name: Create user 'topuser' with password
      run: |
        sudo useradd -m -s /bin/bash topuser
        echo 'topuser:T0pUser#25' | sudo chpasswd
        sudo usermod -aG sudo topuser

    - name: Set GNOME session for xrdp
      run: |
        echo "gnome-session" | sudo tee /home/topuser/.xsession
        sudo chown topuser:topuser /home/topuser/.xsession

    - name: Enable XRDP service
      run: |
        sudo systemctl enable xrdp
        sudo systemctl restart xrdp

    - name: Install Rust
      run: |
        curl https://sh.rustup.rs -sSf -o rustup-init.sh
        chmod +x rustup-init.sh
        ./rustup-init.sh -y
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install bore-cli
      run: cargo install bore-cli

    - name: Start bore tunnel for XRDP (port 3389)
      run: |
        nohup $HOME/.cargo/bin/bore local 3389 --to bore.pub > $GITHUB_WORKSPACE/bore.log 2>&1 &
        echo "Tunnel started. Waiting..."
        sleep 21600  # 6 hours

    - name: Print bore log
      if: always()
      run: |
        echo "Tunnel log output:"
        cat $GITHUB_WORKSPACE/bore.log
