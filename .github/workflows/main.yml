name: XRDP with XFCE and bore.pub (Debug+Optimized)

on:
  workflow_dispatch:

jobs:
  run-xrdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Max allowed by GitHub-hosted runners

    steps:
      - name: Set up fastest APT mirror and apt-fast
        run: |
          # Improve mirror performance
          wget https://raw.githubusercontent.com/vegardit/fast-apt-mirror.sh/v1/fast-apt-mirror.sh -O fast-apt-mirror.sh
          chmod +x fast-apt-mirror.sh
          sudo ./fast-apt-mirror.sh find --apply

          # Silence useless triggers
          sudo rm -f /var/lib/man-db/auto-update
          echo 'path-exclude=/usr/share/man/*' | sudo tee /etc/dpkg/dpkg.cfg.d/01_nodoc > /dev/null
          sudo dpkg-divert --local --rename --add /sbin/initctl
          echo -e '#!/bin/sh\nexit 0' | sudo tee /sbin/initctl > /dev/null
          sudo chmod +x /sbin/initctl

          # Install fast APT
          sudo add-apt-repository -y ppa:apt-fast/stable
          sudo apt-get update
          sudo apt-get install -y apt-fast
          echo debconf apt-fast/maxdownloads string 16 | sudo debconf-set-selections
          echo debconf apt-fast/dlflag boolean true | sudo debconf-set-selections
          echo debconf apt-fast/aptmanager string apt-get | sudo debconf-set-selections

      - name: Install XRDP and XFCE4
        run: |
          sudo apt-fast update
          sudo apt-fast install -y xrdp xfce4 dbus-x11 policykit-1
          echo "xfce4-session" > ~/.xsession
          sudo cp ~/.xsession /etc/skel/.xsession
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Create admin user 'topuser'
        run: |
          sudo adduser --disabled-password --gecos "" topuser
          echo 'topuser:A@12345' | sudo chpasswd
          sudo usermod -aG sudo topuser
          sudo usermod -s /bin/bash topuser
          sudo mkdir -p /home/topuser
          sudo cp ~/.xsession /home/topuser/.xsession
          sudo chown -R topuser:topuser /home/topuser

      - name: Verify XRDP status and port
        run: |
          echo "ğŸ” XRDP Service Status:"
          sudo systemctl status xrdp || true

          echo "ğŸ“„ XRDP Log (last 100 lines):"
          sudo journalctl -u xrdp --no-pager -n 100 || true

          echo "ğŸ”Œ Checking if port 3389 is listening:"
          ss -tlnp | grep 3389 || echo "âŒ Port 3389 is not listening!"

      - name: Download and run bore.pub tunnel (Expose port 3389)
        run: |
          wget https://github.com/ekzhang/bore/releases/download/v0.6.0/bore-v0.6.0-x86_64-unknown-linux-musl.tar.gz -O bore.tar.gz
          tar -xzf bore.tar.gz
          chmod +x bore
          ./bore local 3389 --to bore.pub > bore-url.txt 2>&1 &
          sleep 5
          echo "ğŸŒ bore output:"
          cat bore-url.txt || echo "No bore URL captured."

      - name: Display RDP connection info
        run: |
          echo ""
          echo "======================================"
          echo "âœ… XRDP with XFCE is ready!"
          echo "ğŸ” Credentials:"
          echo "   Username: topuser"
          echo "   Password: A@12345"
          echo ""
          echo "ğŸŒ Public RDP access (via bore.pub):"
          cat bore-url.txt || echo "ğŸš« bore URL not found."
          echo "ğŸ“Œ Use an RDP client to connect (Remmina, mstsc, FreeRDP, etc)"
          echo "======================================"
